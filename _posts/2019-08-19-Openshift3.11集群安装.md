---
layout:     post
title:      Openshift3.11集群安装
subtitle:   安装部署过程介绍
date:       2019-08-19
author:     Frederick
header-img: img/ldap2.jpg
catalog: true
tags:
    - 大数据
    - 分布式
    - Docker
    - kubernets
---

### 安装环境

    CentOS Linux release 7.6.1810 (Core) 

### 集群信息

|主机|   IP  |内存|硬盘大小|备注
|---|------|---|---|---|
|host-192-168-1-12|192.168.1.12|31G|40G+500G|MASTER COMPUTER|
|host-192-168-1-13|192.168.1.13|31G|40G+500G|COMPUTER INFRA|
|host-192-168-1-14|192.168.1.14|31G|40G+500G|COMPUTER|

### 离线docker镜像准备

    yum install docker -y
    systemctl start docker; systemctl enable docker

    docker pull docker.io/openshift/origin-node:v3.11
    docker pull docker.io/openshift/origin-control-plane:v3.11
    docker pull docker.io/openshift/origin-deployer:v3.11.0
    docker pull docker.io/openshift/origin-haproxy-router:v3.11
    docker pull docker.io/openshift/origin-pod:v3.11.0
    docker pull docker.io/openshift/origin-web-console:v3.11
    docker pull docker.io/openshift/origin-docker-registry:v3.11
    docker pull docker.io/openshift/origin-metrics-server:v3.11
    docker pull docker.io/openshift/origin-console:v3.11
    docker pull docker.io/openshift/origin-metrics-heapster:v3.11
    docker pull docker.io/openshift/origin-metrics-hawkular-metrics:v3.11
    docker pull docker.io/openshift/origin-metrics-schema-installer:v3.11
    docker pull docker.io/openshift/origin-metrics-cassandra:v3.11
    docker pull docker.io/cockpit/kubernetes:latest
    docker pull quay.io/coreos/cluster-monitoring-operator:v0.1.1
    docker pull quay.io/coreos/prometheus-config-reloader:v0.23.2
    docker pull quay.io/coreos/prometheus-operator:v0.23.2
    docker pull docker.io/openshift/prometheus-alertmanager:v0.15.2
    docker pull docker.io/openshift/prometheus-node-exporter:v0.16.0
    docker pull docker.io/openshift/prometheus:v2.3.2
    docker pull docker.io/grafana/grafana:5.2.1
    docker pull quay.io/coreos/kube-rbac-proxy:v0.3.1
    docker pull quay.io/coreos/etcd:v3.2.22
    docker pull quay.io/coreos/kube-state-metrics:v1.3.1
    docker pull docker.io/openshift/oauth-proxy:v1.1.0
    docker pull quay.io/coreos/configmap-reload:v0.0.1

### DNS配置

编辑/etc/hosts文件加入以下内容：

    192.168.1.12 openshift1
    192.168.1.13 openshift2
    192.168.1.14 openshift3

### 主机hostname配置




### 设置时区、配置chrony时钟同步

**Openshift默认使用ntp来进行时间同步。如果使用chrony来做时间同步，步骤如下：**

- **(1)设置时区**
	    查看时区: timedatectl
	    设置时区: timedatectl set-timezone Asia/Shanghai

- **(2)开通chrony server的123端口的访问策略（iptables）**
	    sudo iptables -I INPUT -p udp --dport 123 -j ACCEPT
        sudo vi /etc/sysconfig/iptables，增加: -I INPUT -p udp --dport 123 -j ACCEPT
        重启iptables。

- **(3)每台主机开启网络时间同步：**
	    查看时间同步状态：timedatectl status
	    开启时间同步状态：sudo timedatectl set-ntp true

```
# timedatectl status 
Local time: Mon 2019-08-19 11:20:52 CST 
Universal time: Mon 2019-08-19 03:20:52 UTC 
RTC time: Mon 2019-08-19 03:40:59 Time zone: Asia/Shanghai (CST, +0800)
NTP enabled: yes
NTP synchronized: yes
RTC in local TZ: no
DST active: n/a
```        
- **(4)配置chrony服务端与客户端 **
可以在集群内选择一台作为chrony服务器，其他节点从该server同步时间。
chrony一般情况下会已安装，rpm -aq|grep chrony

    **Chrony Server端配置：**
    sudo vi /etc/chrony.conf
    server 10.1.234.164 iburst  #指定本机IP或者上游的时间服务器
    allow 10.1.0.0/16

    **Chrony客户端配置：** vi /etc/chrony.conf
    server 10.1.234.164 iburst  #指定上游的时间服务器

    启动chrony：
    ansible -i dfhosts.cfg all -b -m shell -a "sudo systemctl start chronyd"
    ansible -i dfhosts.cfg all -b -m shell -a "sudo systemctl enable chronyd"
    ansible -i dfhosts.cfg all -b -m shell -a "chronyc sources -v" #查看chrony server源（同步的server的状态显示为^*）


        210 Number of sources = 5

        .-- Source mode  '^' = server, '=' = peer, '#' = local clock.
        / .- Source state '*' = current synced, '+' = combined , '-' = not combined,
        | /   '?' = unreachable, 'x' = time may be in error, '~' = time too variable.
        ||                                                 .- xxxx [ yyyy ] +/- zzzz
        ||      Reachability register (octal) -.           |  xxxx = adjusted offset,
        ||      Log2(Polling interval) --.      |          |  yyyy = measured offset,
        ||                                \     |          |  zzzz = estimated error.
        ||                                 |    |           \
        MS Name/IP address         Stratum Poll Reach LastRx Last sample
        ===============================================================================
        ^* openshift1                    3   7   377    97    +70us[ +154us] +/-   90ms
        ^? undefined.hostname.local>     0  10     0     -     +0ns[   +0ns] +/-    0ns
        ^? 139.199.214.202               0  10     0     -     +0ns[   +0ns] +/-    0ns
        ^? ntp7.flashdance.cx            0  10     0     -     +0ns[   +0ns] +/-    0ns
        ^? amy.chl.la                    0  10     0     -     +0ns[   +0ns] +/-    0ns